"use client";

import { useState, useMemo, useEffect } from "react";
import { createClient, SupabaseClient, User } from "@supabase/supabase-js";
import "./ClubSearch.css";

interface Club {
  id: number;
  name: string;
  city: string;
  country: string;
  logo_url: string;
  rating?: number;
}

interface ClubSearchProps {
  initialClubs?: Club[];
}

export default function ClubSearch({ initialClubs = [] }: ClubSearchProps) {
  const [search, setSearch] = useState("");
  const [country, setCountry] = useState("");
  const [city, setCity] = useState("");
  const [user, setUser] = useState<User | null>(null);
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [loginOpen, setLoginOpen] = useState(false);

  const supabase: SupabaseClient = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );

  // Prüfe Login-Status
  useEffect(() => {
    supabase.auth.getUser().then(({ data }) => setUser(data?.user ?? null));
  }, [supabase]);

  // Login
  const handleLogin = async () => {
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });
    if (error) alert(error.message);
    else setUser(data.user);
  };

  // Logout
  const handleLogout = async () => {
    await supabase.auth.signOut();
    setUser(null);
  };

  // Registrierung
  const handleRegister = async () => {
    const { error } = await supabase.auth.signUp({
      email,
      password,
    });
    if (error) alert("Fehler bei Registrierung: " + error.message);
    else alert("Registrierung erfolgreich! Bitte E-Mail bestätigen.");
  };

  // Passwort zurücksetzen
  const handleResetPassword = async () => {
    if (!email) {
      alert("Bitte E-Mail-Adresse eingeben!");
      return;
    }
    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: window.location.origin,
    });
    if (error) alert("Fehler beim Zurücksetzen: " + error.message);
    else alert("E-Mail zum Zurücksetzen gesendet!");
  };

  // Filterlogik
  const filteredClubs = useMemo(() => {
    return initialClubs.filter((club) => {
      const matchText =
        club.name.toLowerCase().includes(search.toLowerCase()) ||
        club.city.toLowerCase().includes(search.toLowerCase()) ||
        club.country.toLowerCase().includes(search.toLowerCase());
      const matchCountry = country ? club.country === country : true;
      const matchCity = city ? club.city === city : true;
      return matchText && matchCountry && matchCity;
    });
  }, [search, country, city, initialClubs]);

  const countries = Array.from(new Set(initialClubs.map((c) => c.country))).sort();
  const cities = Array.from(new Set(initialClubs.map((c) => c.city))).sort();

  const filteredCountryCount = useMemo(() => {
    return new Set(filteredClubs.map((c) => c.country)).size;
  }, [filteredClubs]);

  // ClubCard-Komponente (integriert)
  const ClubCard = ({ club }: { club: Club }) => {
    const [rating, setRating] = useState<number>(club.rating || 0);

    const handleRating = async (value: number) => {
      if (!user) {
        alert("Bitte einloggen, um zu bewerten!");
        return;
      }
      setRating(value);
      const { error } = await supabase
        .from("clubs")
        .update({ rating: value })
        .eq("id", club.id);
      if (error) alert("Fehler beim Speichern der Bewertung: " + error.message);
    };

    return (
      <div className="club-card">
        <img src={club.logo_url} alt={club.name} className="club-logo" />
        <h3>{club.name}</h3>
        <p>
          {club.city}, {club.country}
        </p>
        <div className="stars">
          {[1, 2, 3, 4, 5].map((i) => (
            <span
              key={i}
              onClick={() => handleRating(i)}
              className={`star ${i <= rating ? "active" : ""}`}
            >
              ★
            </span>
          ))}
        </div>
      </div>
    );
  };

  return (
    <div className="club-search-container">
      <div className="main-content">
        {/* Filterfelder */}
        <div className="filters">
          <input
            type="text"
            placeholder="Suche..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
          />
          <select value={country} onChange={(e) => setCountry(e.target.value)}>
            <option value="">Alle Länder</option>
            {countries.map((c) => (
              <option key={c} value={c}>
                {c}
              </option>
            ))}
          </select>
          <select value={city} onChange={(e) => setCity(e.target.value)}>
            <option value="">Alle Städte</option>
            {cities.map((c) => (
              <option key={c} value={c}>
                {c}
              </option>
            ))}
          </select>
        </div>

        {/* Loginbereich unterhalb der Filter */}
        <div className="login-inline-container">
          <div
            className="login-inline-header"
            onClick={() => setLoginOpen((prev) => !prev)}
          >
            {user ? (
              <p>
                Eingeloggt als <strong>{user.email}</strong> ▾
              </p>
            ) : (
              <p>Nicht eingeloggt ▾</p>
            )}
          </div>

          {loginOpen && (
            <div className="login-inline-panel">
              {user ? (
                <div className="logged-in">
                  <button onClick={handleLogout} className="btn logout-btn">
                    Logout
                  </button>
                </div>
              ) : (
                <div className="login-forms">
                  <input
                    type="email"
                    placeholder="E-Mail"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                  />
                  <input
                    type="password"
                    placeholder="Passwort"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                  />
                  <div className="login-buttons">
                    <button onClick={handleLogin} className="btn login-btn">
                      Login
                    </button>
                    <button onClick={handleRegister} className="btn register-btn">
                      Registrieren
                    </button>
                  </div>
                  <button onClick={handleResetPassword} className="link-btn">
                    Passwort vergessen?
                  </button>
                </div>
              )}
            </div>
          )}
        </div>

        <h2>
          (Anzahl Clubs: {filteredClubs.length} / Anzahl Länder:{" "}
          {filteredCountryCount} Ländern)
        </h2>

        <div className="club-grid">
          {filteredClubs.map((club) => (
            <ClubCard key={club.id} club={club} />
          ))}
        </div>
      </div>
    </div>
  );
}
